<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø´Ø§ÙˆÙŠØ± ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ø³Ù‚Ø§</title>
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f4f6f9;color:#222}
header{background:#007bff;color:white;padding:10px;text-align:center;font-size:20px;position:relative}
#date{font-size:14px;margin-top:5px;opacity:.9}
.container{padding:15px;max-width:900px;margin:0 auto}
input{display:block;width:100%;padding:10px;margin:6px 0;font-size:16px;border-radius:8px;border:1px solid #ccc}
.btn{padding:10px 15px;border:none;border-radius:8px;cursor:pointer;font-size:15px}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn-start{background:#28a745;color:white}
.btn-end{background:#dc3545;color:white}
.btn-cancel{background:#ffc107;color:#000}
.btn-toggle{background:#007bff;color:white}
.btn-archive{background:#6f42c1;color:white}
.btn-danger{background:#ff4d4d;color:#fff}
.btn-group{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 6px}
.trip-card{background:white;padding:10px 12px;margin:8px 0;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.08);font-size:14px;display:flex;gap:10px;align-items:center;position:relative;transition:background .25s,border .25s}
.trip-card .content{flex:1}
.current{background:#e6f2ff;border:2px solid #007bff}
.hidden{display:none}
table{width:100%;border-collapse: collapse;margin-bottom:10px;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,0.06)}
th,td{border:1px solid #ddd;padding:8px 6px;text-align:center;font-size:14px}
th{background:#007bff;color:white;position:sticky;top:0}
tbody tr:nth-child(even){background:#f9fbff}
.select-col{width:64px}
.action-col{white-space:nowrap}
#toast{visibility:hidden;min-width:250px;background:#333;color:#fff;text-align:center;border-radius:8px;padding:12px;position:fixed;left:50%;bottom:30px;transform:translateX(-50%);font-size:16px;opacity:0;transition:opacity .4s,bottom .4s;z-index:1000}
#toast.show{visibility:visible;opacity:1;bottom:50px}
#splash{position:fixed;inset:0;background:white;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:22px;z-index:2000}
#splash img{width:84px;margin-bottom:14px}
.status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-left:6px;vertical-align:middle}
.online{background:#28a745}.offline{background:#dc3545}
#loginScreen{padding:20px;max-width:400px;margin:50px auto;background:white;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.1);}
</style>
</head>
<body>

<!-- Splash -->
<div id="splash">
  <img src="https://img.icons8.com/color/96/000000/pharmacy-shop.png" alt="logo"/>
  <div>Ø£Ù‡Ù„Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø´Ø§ÙˆÙŠØ± ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ø³Ù‚Ø§</div>
</div>

<!-- Login Screen -->
<div id="loginScreen" class="hidden">
  <h3 style="text-align:center;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
  <input type="text" id="loginName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨">
  <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
  <button id="loginBtn" class="btn btn-start" style="width:100%;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- Main App -->
<div id="app" class="hidden">
  <header>
    Ø¥Ø¯Ø§Ø±Ø© Ù…Ø´Ø§ÙˆÙŠØ± ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ø³Ù‚Ø§
    <div id="date"></div>
    <div style="position:absolute;top:10px;left:10px;font-size:12px">
      <span id="netDot" class="status-dot offline"></span><span id="netText">Ø£ÙˆÙÙ„Ø§ÙŠÙ†</span>
    </div>
    <button id="logoutBtn" class="btn btn-danger" style="position:absolute;right:10px;top:10px">Ø®Ø±ÙˆØ¬</button>
  </header>

  <div class="container">
    <input type="text" id="destination" placeholder="Ø§Ù„ÙˆØ¬Ù‡Ø©">

    <div class="btn-group">
      <button id="startBtn" class="btn btn-start">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±</button>
      <button id="endBtn" class="btn btn-end">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±</button>
      <button id="cancelBtn" class="btn btn-cancel">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±</button>
      <button id="toggleLog" class="btn btn-toggle">ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„</button>
      <button id="toggleArchive" class="btn btn-toggle">ğŸ—„ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
    </div>

    <h3 style="margin:12px 0 6px">Ø§Ù„Ù…Ø´ÙˆØ§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
    <div id="currentTrip"></div>

    <div id="logSection" class="hidden">
      <h3 style="margin:14px 0 8px">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´Ø§ÙˆÙŠØ±</h3>
      <div class="btn-group">
        <button id="selectToggleBtn" class="btn">âœ… ØªØ­Ø¯ÙŠØ¯</button>
        <button id="archiveSelectedBtn" class="btn btn-archive hidden">ğŸ—„ï¸ Ø£Ø±Ø´ÙØ© Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
        <button id="clearSelectedBtn" class="btn btn-danger hidden">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
        <button id="clearAllBtn" class="btn btn-danger">Ù…Ø³Ø­ Ø§Ù„Ø¬Ù…ÙŠØ¹</button>
        <button id="exportLogBtn" class="btn btn-toggle">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
      </div>
      <div id="tripLog"></div>
    </div>

    <div id="archivedSection" class="hidden">
      <h3 style="margin:14px 0 8px">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h3>
      <div class="btn-group">
        <button id="exportArchiveBtn" class="btn btn-toggle">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
      </div>
      <div id="archiveLog"></div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js"></script>

<script>
// ===== Firebase Config =====
const firebaseConfig = {
  apiKey:"AIzaSyCuCRsXNu4hXJtS_rXZmaazbGEz8XhV4PI",
  authDomain:"elsaka-data-pharmacy.firebaseapp.com",
  databaseURL:"https://elsaka-data-pharmacy-default-rtdb.firebaseio.com/",
  projectId:"elsaka-data-pharmacy",
  storageBucket:"elsaka-data-pharmacy.firebasestorage.app",
  messagingSenderId:"182478040389",
  appId:"1:182478040389:web:20a314996f3a256043622c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== Helpers =====
const $ = s=>document.querySelector(s);
const toast = m => { const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),3000); };
const fmtTime = d => new Date(d).toLocaleTimeString("ar-EG");
const fmtDate = d => { const dt=new Date(d); return `${String(dt.getMonth()+1).padStart(2,"0")}/${String(dt.getDate()).padStart(2,"0")}`; };
const durStr = (secs) => `${Math.floor(secs/60)} Ø¯Ù‚ÙŠÙ‚Ø© ${secs%60} Ø«Ø§Ù†ÙŠØ©`;
$("#date").textContent = `${new Date().getMonth()+1}/${new Date().getDate()}`;

// ===== Network Status =====
function updateNetUI(){
  const online = navigator.onLine;
  $("#netDot").classList.toggle("online",online);
  $("#netDot").classList.toggle("offline",!online);
  $("#netText").textContent = online?"Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†":"Ø£ÙˆÙÙ„Ø§ÙŠÙ†";
}
window.addEventListener("online",updateNetUI);
window.addEventListener("offline",updateNetUI);
updateNetUI();

// ===== Splash Screen =====
window.onload = () => {
  setTimeout(()=>{
    const splash = document.getElementById("splash");
    const loginScreen = document.getElementById("loginScreen");
    if(splash) splash.style.display = "none";
    if(loginScreen) loginScreen.classList.remove("hidden");
  }, 700);
};

// ===== Global Variables =====
let currentUser = null;
let mirror = {current:null,trips:{},archive:{}};
let timer=null,endInFlight=false,selectMode=false;

// ===== Load User from LocalStorage =====
if(localStorage.getItem("currentUser")){
  currentUser = localStorage.getItem("currentUser");
  $("#loginScreen").classList.add("hidden");
  $("#app").classList.remove("hidden");
}

// ===== Users =====
const users = { "Ahmed":"123456", "Ali":"abcdef", "Mona":"0000" };

// ===== Login =====
$("#loginBtn").onclick = ()=>{
  const name = $("#loginName").value.trim();
  const pass = $("#loginPass").value.trim();
  if(!name||!pass){ alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±"); return; }
  if(!users[name] || users[name]!==pass){ alert("Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦"); return; }

  currentUser = name;
  localStorage.setItem("currentUser",currentUser);
  $("#loginScreen").classList.add("hidden");
  $("#app").classList.remove("hidden");
  toast(`âœ… Ù…Ø±Ø­Ø¨Ù‹Ø§ ${currentUser}`);
  loadData();
};

// ===== Logout =====
$("#logoutBtn").onclick = ()=>{
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) return;
  localStorage.removeItem("currentUser");
  location.reload();
};

// ===== Firebase References =====
const currentRef = db.ref("currentTrip");
const tripsRefRoot = db.ref("trips");
const archiveRefRoot = db.ref("archivedTrips");

// ===== Load Data =====
function loadData(){
  currentRef.on("value",snap=>{
    const c = snap.exists()? snap.val(): null;
    if(c && c.delegate!==currentUser){ mirror.current=null; } else { mirror.current=c; }
    renderCurrent();
  });

  tripsRefRoot.on("value",snap=>{
    const all = snap.exists()? snap.val(): {};
    mirror.trips = Object.fromEntries(Object.entries(all).filter(([id,t])=>t.delegate===currentUser));
    renderTables();
  });

  archiveRefRoot.on("value",snap=>{
    const all = snap.exists()? snap.val(): {};
    mirror.archive = Object.fromEntries(Object.entries(all).filter(([id,t])=>t.delegate===currentUser));
    renderTables();
  });
}

// ===== Current Trip =====
function renderCurrent(){
  const host = $("#currentTrip");
  host.innerHTML="";
  stopTick();
  if(!mirror.current) return;

  const start = new Date(mirror.current.startTime);
  const card = document.createElement("div");
  card.className="trip-card current";
  card.innerHTML=`
    <div class="content">
      <div><strong>${mirror.current.delegate}</strong> â€” ${mirror.current.destination}</div>
      <div>â±ï¸ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ${fmtTime(start)}</div>
      <div>ğŸ“… ${fmtDate(start)}</div>
      <div id="currentDuration">Ø§Ù„Ù…Ø¯Ø©: 0 Ø¯Ù‚ÙŠÙ‚Ø© 0 Ø«Ø§Ù†ÙŠØ©</div>
    </div>`;
  host.appendChild(card);
  startTick();
}
function startTick(){ stopTick(); timer=setInterval(()=>{
  if(!mirror.current) return;
  const s=Math.floor((Date.now()-new Date(mirror.current.startTime).getTime())/1000);
  const el=$("#currentDuration"); if(el) el.textContent=`Ø§Ù„Ù…Ø¯Ø©: ${durStr(s)}`;
},1000);}
function stopTick(){ if(timer){ clearInterval(timer); timer=null; }}

// ===== Start Trip =====
$("#startBtn").onclick = async ()=>{
  if(!currentUser){ alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"); return; }
  const dest = $("#destination").value.trim();
  if(!dest){ alert("Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆØ¬Ù‡Ø©"); return; }
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±ØŸ")) return;
  if(mirror.current){ alert("Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙˆØ§Ø± Ø¬Ø§Ø±ÙŠ Ø¨Ø§Ù„ÙØ¹Ù„"); return; }

  const payload = { currentId:crypto.randomUUID(), delegate:currentUser, destination:dest, startTime:new Date().toISOString() };
  await currentRef.set(payload);
  $("#destination").value="";
  toast("âœ… ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±");
};

// ===== End Trip =====
$("#endBtn").onclick = async ()=>{
  if(!mirror.current){ alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ÙˆØ§Ø± Ø¬Ø§Ø±ÙŠ"); return; }
  if(endInFlight) return;
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±ØŸ")) return;

  endInFlight=true;
  $("#endBtn").disabled=true;
  try{
    const tripId = mirror.current.currentId || crypto.randomUUID();
    const finished = { id:tripId, delegate:mirror.current.delegate, destination:mirror.current.destination, startTime:mirror.current.startTime, endTime:new Date().toISOString() };
    const updates={}; updates[`trips/${tripId}`]=finished; updates[`currentTrip`]=null;
    await db.ref().update(updates);
    toast("ğŸ ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±");
  }catch(e){ alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡"); }
  finally{ endInFlight=false; $("#endBtn").disabled=false; }
};

// ===== Cancel Trip =====
$("#cancelBtn").onclick = async ()=>{
  if(!mirror.current){ alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ÙˆØ§Ø± Ø¬Ø§Ø±ÙŠ"); return; }
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±ØŸ")) return;
  await currentRef.set(null);
  toast("âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±");
};

// ===== Toggle Log & Archive =====
$("#toggleLog").onclick=()=>{$("#logSection").classList.toggle("hidden"); $("#toggleLog").textContent=$("#logSection").classList.contains("hidden")?"ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„":"Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø¬Ù„";};
$("#toggleArchive").onclick=()=>{$("#archivedSection").classList.toggle("hidden"); $("#toggleArchive").textContent=$("#archivedSection").classList.contains("hidden")?"ğŸ—„ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø´ÙŠÙ":"Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø±Ø´ÙŠÙ";};

// ===== Render Tables =====
function renderTableByDay(data, hostId, isArchive=false){
  const host=$(hostId); host.innerHTML="";
  if(!data || Object.keys(data).length===0) return;
  const grouped={};
  Object.entries(data).forEach(([key,val])=>{ const day=fmtDate(val.startTime); if(!grouped[day]) grouped[day]=[]; grouped[day].push({key,val}); });
  Object.keys(grouped).sort((a,b)=>{ const [am,ad]=a.split('/').map(Number); const [bm,bd]=b.split('/').map(Number); return new Date(new Date().getFullYear(),bm-1,bd) - new Date(new Date().getFullYear(),am-1,ad); }).forEach(day=>{
    const dayDiv=document.createElement("div"); dayDiv.innerHTML=`<h4 style="margin:10px 0 4px">ğŸ“… ${day}</h4>`;
    const table=document.createElement("table");
    const thead=document.createElement("thead");
    thead.innerHTML=`<tr><th class="select-col">ØªØ­Ø¯ÙŠØ¯</th><th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th>Ø§Ù„ÙˆØ¬Ù‡Ø©</th><th>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th><th>Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th class="action-col">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr>`;
    table.appendChild(thead);
    const tbody=document.createElement("tbody");
    grouped[day].sort((a,b)=>new Date(b.val.startTime)-new Date(a.val.startTime)).forEach(({key,val})=>{
      const start=new Date(val.startTime); const end=val.endTime? new Date(val.endTime): null; const secs=end?Math.floor((end-start)/1000):0;
      const tr=document.createElement("tr");
      const tdCheck=document.createElement("td");
      if(!isArchive){ const checkbox=document.createElement("input"); checkbox.type="checkbox"; checkbox.className="select-box"; checkbox.dataset.key=key; checkbox.style.display=selectMode?"inline-block":"none"; tdCheck.appendChild(checkbox);}
      tr.appendChild(tdCheck);
      tr.innerHTML+=`<td>${val.delegate}</td><td>${val.destination}</td><td>${fmtTime(start)}</td><td>${end?fmtTime(end):"Ø¬Ø§Ø±ÙŠ"}</td><td>${durStr(secs)}</td>`;
      const tdAction=document.createElement("td");
      if(isArchive){ const restoreBtn=document.createElement("button"); restoreBtn.className="btn btn-archive"; restoreBtn.textContent="â†©ï¸ Ø§Ø³ØªØ±Ø¬Ø§Ø¹"; restoreBtn.onclick=()=>restoreFromArchive(key,val); tdAction.appendChild(restoreBtn);}
      else{ const delBtn=document.createElement("button"); delBtn.className="btn btn-danger"; delBtn.textContent="Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ"; delBtn.onclick=()=>deleteTripForever(key); tdAction.appendChild(delBtn);}
      tr.appendChild(tdAction); tbody.appendChild(tr);
    });
    table.appendChild(tbody); dayDiv.appendChild(table); host.appendChild(dayDiv);
  });
}
function renderTables(){ renderTableByDay(mirror.trips,"#tripLog",false); renderTableByDay(mirror.archive,"#archiveLog",true);}

// ===== Archive / Delete / Restore =====

$("#selectToggleBtn").onclick = () => {
  selectMode = !selectMode;
  $("#selectToggleBtn").textContent = selectMode ? "âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯" : "âœ… ØªØ­Ø¯ÙŠØ¯";
  $("#clearSelectedBtn").classList.toggle("hidden", !selectMode);
  $("#archiveSelectedBtn").classList.toggle("hidden", !selectMode);
  document.querySelectorAll("#tripLog .select-box").forEach(cb => {
    cb.checked = false;
    cb.style.display = selectMode ? "inline-block" : "none";
  });
};

$("#archiveSelectedBtn").onclick = async () => {
  const ids = Array.from(document.querySelectorAll("#tripLog .select-box:checked")).map(cb => cb.dataset.key);
  if (!ids.length) { alert("Ø§Ø®ØªØ± Ø³Ø¬Ù„Ø§Øª Ù„Ø£Ø±Ø´ÙØªÙ‡Ø§"); return; }
  if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø£Ø±Ø´ÙØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©ØŸ")) return;
  const updates = {};
  ids.forEach(id => { const val = mirror.trips[id]; if (val) { updates[`archivedTrips/${id}`] = val; updates[`trips/${id}`] = null; } });
  await db.ref().update(updates);
  toast("ğŸ—„ï¸ ØªÙ… Ø£Ø±Ø´ÙØ© Ø§Ù„Ù…Ø­Ø¯Ø¯");
};

$("#clearSelectedBtn").onclick = async () => {
  const ids = Array.from(document.querySelectorAll("#tripLog .select-box:checked")).map(cb => cb.dataset.key);
  if (!ids.length) { alert("Ø§Ø®ØªØ± Ø³Ø¬Ù„Ø§Øª Ù„Ù…Ø³Ø­Ù‡Ø§"); return; }
  if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ø¹ Ø§Ù„Ø£Ø±Ø´ÙØ©ØŸ")) return;
  const updates = {};
  ids.forEach(id => { const val = mirror.trips[id]; if (val) { updates[`archivedTrips/${id}`] = val; updates[`trips/${id}`] = null; } });
  await db.ref().update(updates);
  toast("ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙˆØ§Ù„Ø£Ø±Ø´ÙØ©");
};

$("#clearAllBtn").onclick = async () => {
  if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„ØŸ")) return;
  const updates = {};
  Object.entries(mirror.trips).forEach(([id, val]) => { updates[`archivedTrips/${id}`] = val; updates[`trips/${id}`] = null; });
  await db.ref().update(updates);
  toast("ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø£Ø±Ø´ÙØ©");
};

async function restoreFromArchive(id, val) {
  if (!confirm("Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´ÙˆØ§Ø± Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙØŸ")) return;
  const updates = {};
  updates[`trips/${id}`] = val;
  updates[`archivedTrips/${id}`] = null;
  await db.ref().update(updates);
  toast("â™»ï¸ ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹");
}

async function deleteTripForever(id) {
  if (!confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø¯ÙˆÙ† Ø£Ø±Ø´ÙØ©ØŸ")) return;
  const updates = {};
  updates[`trips/${id}`] = null;
  await db.ref().update(updates);
  toast("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ");
}

// ===== Export Excel =====
function exportToExcel(data, filename) {
  if (!data || Object.keys(data).length === 0) { toast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±"); return; }
  const arr = [];
  Object.entries(data).forEach(([k, v]) => {
    const start = new Date(v.startTime); 
    const end = v.endTime ? new Date(v.endTime) : null; 
    const secs = end ? Math.floor((end - start) / 1000) : 0;
    arr.push({
      Delegate: v.delegate,
      Destination: v.destination,
      Start: fmtTime(start),
      End: end ? fmtTime(end) : "Ø¬Ø§Ø±ÙŠ",
      Duration: durStr(secs),
      Date: fmtDate(start)
    });
  });
  const ws = XLSX.utils.json_to_sheet(arr);
  ws['!cols'] = [{ wch: 14 }, { wch: 18 }, { wch: 12 }, { wch: 12 }, { wch: 16 }, { wch: 10 }];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Trips");
  XLSX.writeFile(wb, filename);
}

$("#exportLogBtn").onclick = () => exportToExcel(mirror.trips, "Ø³Ø¬Ù„_Ø§Ù„Ù…Ø´Ø§ÙˆÙŠØ±.xlsx");
$("#exportArchiveBtn").onclick = () => exportToExcel(mirror.archive, "Ø£Ø±Ø´ÙŠÙ_Ø§Ù„Ù…Ø´Ø§ÙˆÙŠØ±.xlsx");
</script>
</body>
</html>